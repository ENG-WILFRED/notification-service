# Notification Service (Kafka + Node.js + TypeScript)

A production-ready, event-driven notification service that queues and delivers emails and SMS via Kafka. Features modular architecture with TypeScript strict mode, retry logic with exponential backoff, template rendering, and Swagger API documentation.

## Architecture

```
┌─────────────────┐
│   HTTP Client   │
└────────┬────────┘
         │
         ▼
┌─────────────────────────────────────────┐
│      Express Producer API                │
│  POST /notify  │  GET /health            │
│  (validates & publishes to Kafka)        │
└────────────────┬────────────────────────┘
                 │
                 ▼
         ┌──────────────────┐
         │  Kafka Cluster   │
         │  (notifications) │
         └────────┬─────────┘
                  │
                  ▼
         ┌──────────────────────────────┐
         │  Consumer Service            │
         │  (subscribe + process)       │
         └──────────┬───────────────────┘
                    │
         ┌──────────┴──────────┐
         │                     │
         ▼                     ▼
    ┌─────────────┐      ┌──────────────┐
    │Email Provider│      │SMS Provider  │
    │ (Nodemailer)│      │ (Twilio)     │
    └─────────────┘      └──────────────┘
```

## Quick Start

### 1. Start Kafka

```bash
docker-compose up -d
```

This spins up Zookeeper and Kafka locally.

### 2. Install & Build

```bash
npm install
npm run build
```

### 3. Run Producer

```bash
npm start
```

The API listens on `http://localhost:3000` and Swagger docs are at `http://localhost:3000/api-docs`.

### 4. Run Consumer (new terminal)

```bash
npm run consumer
```

## Development Mode

For development with auto-reload:

```bash
npm run dev              # Producer with ts-node
npm run dev:consumer     # Consumer with ts-node
```

## API Endpoints

### `POST /notify`

Queue a notification.

**Request:**
```json
{
  "to": "user@example.com",
  "channel": "email",
  "template": "welcome_email",
  "data": {
    "name": "Alice",
    "message": "Welcome aboard!"
  },
  "idempotency_key": "optional-unique-key"
}
```

**Response:** `202 Accepted`
```json
{
  "status": "queued",
  "id": "uuid-v4"
}
```

### `GET /health`

Health check.

**Response:** `200 OK`
```json
{
  "status": "ok",
  "timestamp": "2025-12-20T12:34:56.789Z"
}
```

## Swagger Docs

Visit `http://localhost:3000/api-docs` after starting the server.

## Configuration

Copy `.env.example` to `.env` and customize:

```bash
cp .env.example .env
```

**Environment Variables:**

- `KAFKA_BROKER` – Kafka broker address (default: `localhost:9092`)
- `KAFKA_CLIENT_ID` – Client identifier (default: `notification-service`)
- `PORT` – API port (default: `3000`)
- `SMTP_HOST` – SMTP server (optional; falls back to logging)
- `SMTP_PORT` – SMTP port (default: `587`)
- `SMTP_USER` – SMTP username
- `SMTP_PASS` – SMTP password
- `SMTP_FROM` – From email address (default: `no-reply@example.com`)
- `TWILIO_ACCOUNT_SID` – Twilio account (optional; falls back to logging)
- `TWILIO_AUTH_TOKEN` – Twilio token
- `TWILIO_FROM` – Twilio phone number

## Project Structure

```
src/
├── app.ts                   # Express producer server
├── consumer.ts              # Kafka consumer & dispatcher
├── config.ts                # Centralized configuration
├── routes/
│   ├── notify.ts            # POST /notify endpoint + Swagger doc
│   └── health.ts            # GET /health endpoint + Swagger doc
├── services/
│   ├── kafkaProducer.ts     # Kafka producer service
│   └── kafkaConsumer.ts     # Kafka consumer factory
├── providers/
│   ├── email.ts             # Email provider (Nodemailer)
│   └── sms.ts               # SMS provider (Twilio)
├── templates/
│   ├── welcome_email.txt
│   └── otp_sms.txt
├── types/
│   └── swagger-jsdoc.d.ts   # Type declarations
└── utils/
    ├── templateRenderer.ts  # Simple {{ var }} renderer
    └── swagger.ts           # Swagger/OpenAPI spec

dist/                        # Compiled JavaScript (generated by tsc)
tsconfig.json                # TypeScript configuration
docker-compose.yml           # Dev infrastructure
package.json
.env.example
README.md
```

## TypeScript Features

✓ **Strict Type Checking** – `strict: true` in tsconfig.json  
✓ **Source Maps** – Debug compiled code with original TypeScript  
✓ **Type Definitions** – Full typing for all services and routes  
✓ **Declaration Files** – Type information for consumers  
✓ **Custom Type Interfaces** – `Config`, `NotificationPayload`, etc.  

## Retry Logic

Failed sends are retried up to 5 times with exponential backoff:
- Attempt 1: wait 1 second
- Attempt 2: wait 2 seconds
- Attempt 3: wait 4 seconds
- Attempt 4: wait 8 seconds
- Attempt 5: wait 16 seconds
(capped at 30 seconds)

## Mock vs Real Providers

**Email:**
- If `SMTP_HOST` is set: uses Nodemailer to send real emails
- Otherwise: logs to console

**SMS:**
- If `TWILIO_ACCOUNT_SID` is set: sends via Twilio
- Otherwise: logs to console

## Example Workflows

### Email Welcome

```bash
curl -X POST http://localhost:3000/notify \
  -H "Content-Type: application/json" \
  -d '{
    "to": "alice@example.com",
    "channel": "email",
    "template": "welcome_email",
    "data": { "name": "Alice", "message": "Thanks for signing up!" }
  }'
```

### SMS OTP

```bash
curl -X POST http://localhost:3000/notify \
  -H "Content-Type: application/json" \
  -d '{
    "to": "+15551234567",
    "channel": "sms",
    "template": "otp_sms",
    "data": { "code": "654321" }
  }'
```

## Scripts

```bash
npm run build         # Compile TypeScript to JavaScript
npm start             # Run compiled producer API
npm run consumer      # Run compiled consumer
npm run dev           # Run producer with ts-node
npm run dev:consumer  # Run consumer with ts-node
```

## Build & Compile

```bash
# Compile TypeScript to dist/ folder
npm run build

# Output includes:
# - JavaScript files (.js)
# - Source maps (.js.map)
# - Type declarations (.d.ts)
```

## Notes

- Idempotency keys prevent duplicate sends (optional)
- Templates use simple `{{ variable }}` syntax
- Graceful shutdown on SIGTERM
- Kafka consumer group ensures only one consumer processes per partition
- All configuration via environment variables
- Type safety with TypeScript strict mode

## License

MIT
